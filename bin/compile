#!/bin/sh

env_dir=$1
acceptlist_regex=${2:-''}
denylist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
if [ -d "$env_dir" ]; then
  for e in $(ls $env_dir); do
    echo "$e" | grep -E "$acceptlist_regex" | grep -qvE "$denylist_regex" &&
      export "$e=$(cat $env_dir/$e)"
    :
  done
fi

export BUILD_DIR=$1
bp_dir=$(
  cd $(dirname $0)
  cd ..
  pwd
)

if [ ! -f "$BUILD_DIR/.gitmodules" ]; then
  echo "-----> No .gitmodules file found. Skipping."
  exit 0
fi

export GEM_HOME=$bp_dir/vendor/gems
export GEM_PATH=$bp_dir/vendor/gems

echo "---> Installing parseconfig gem"
gem install 'parseconfig'

ruby $bp_dir/bin/install_git_submodules.rb
